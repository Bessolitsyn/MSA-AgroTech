Container### <a name="_b7urdng99y53"></a>**Название задачи:** 
Выбор технологий и сервисов для реализации системы 
### <a name="_hjk0fkfyohdk"></a>**Автор:**
Бессолицын Антон
### <a name="_uanumrh8zrui"></a>**Дата:**
29.07.2025
### <a name="_3bfxc9a45514"></a>**Принятые решения**
Архитектурное решение на контекстном уровне принято и предтставлено в [ADR-C1](../TASK1/ADR-С1.md)
[Основная диаграмма контекста](../TASK1/agrotech_v1_С1.puml) 

### <a name="_qmphm5d6rvi3"></a>**Решения по сервисам и технологиям**
Основное решение по сервисам в контейнерой диаграмме [C2](agrotech_v1_С2.puml)

Определены следующие сервисы:
- шлюз системы жизнеобеспеченияя животных - обеспечивает потоковую передачу унифицированных соообщений 
- шлюз системы видеонаблюдения - обеспечивает потоковую передачу видео во внешнюю ИИ-систему по средствам WebRTC. 
- брокер сообщений(шина данных) - обеспечивает взаимодествие сервисов, обработку и хранение сообщений
- сервис мониторинга - обеспечивает обработку потоковых метрических данных, реализует бизнес-логику платформы   (генерация оповещений, уведомлений, сохранение в БД) 
- аналитический сервис - обеспечивает обработку потоковых метрических данных, реализует бизнес-логику платформы  (анализ событий, ежедневные отчеты о работе хозяйства отчеты потребления ресурсов, сохранение в БД)
- агент - сервис сбора данных находящихся в хранилище, реализует политику передачи данных о хозяйстве в центральное хранилище
- сервис сбора данных от хозяйств  - обрабатывает данные хозяйств RESTful-сервис, точка входа в центральную систему компании 
- API сервис - точка входа в платформу для клиентских приложенний

***Брокер сообщения***
Apache Kafka будет использоваться в качестве брокера сообщения.
- данная технология обеспечивает потоковую обработку данных от систем жизнеобеспечения и ИИ-сиcтемы. 
- относительно не требовательна к ресурсам, легко кластеризуется, не будет сложности в развертывании и эксплуатации в хозяйство.
- высокая скорость и количество обработки сообщений  
- возможность обеспечит гарантированность доставки сообщений и их хранение 
сервисы взаимодейтсвующие с брокером, используют протокол брокера
Альтернативный брокер RabbitMQ.  
В таблице предоставленной нейросетью ниже сравнение брокеров.
|Критерий|RabbitMQ|Apache Kafka|
| :-: | :- | :- |
Тип системы	|Классический брокер сообщений (Message Broker)	|Распределённая |система потоковой обработки (Event Streaming Platform)
Архитектура	|Очереди (Queues) и Exchange (Pub-Sub)	|Журнал сообщений (Log-based) + партиции
Скорость	|~50K–100K сообщений/сек (на ноде)	|~1M+ сообщений/сек (в кластере)
Задержка	|Миллисекунды	|Десятки миллисекунд – секунды (из-за репликации)
Гарантии доставки	|Подтверждение (ACK), Dead Letter Queue	|Репликация, гарантия порядка в партиции
Хранение данных	|Удаление после обработки (если не настроено иное)	|Хранит сообщения долго (дни/недели)
Масштабируемость	|Вертикально (ноды) + кластер	|Горизонтально (партиции + брокеры)
Использование	|Задачи в реальном времени (RPC, таски)	|Потоковая аналитика, логгинг, Event Sourcing

RabbitMQ не реализует паттерн Producer-Concumer и не имеет потоковую обработку сообщений. Это не соответвует основной архитектуре
RabbitMQ не имеет встроенных возможностей по хранению и обработки потока сообщений.
Имеет сложности в горизонтальной масштабируемостью. 

***Синхронизация с АгроПромХ***
Проблема синхронизации данных с центральным хранилищем копмании решена, как видно на схеме [C2](agrotech_v1_С2.puml)
использованием отдельного сервиса. Данный сервис реализует логику синхронизации с хранилищем. Задача его гарантировать доставку данных в главное хранилище.
Все необходимые данные аккумулируются в хранилище. Очистка хранилища от переданных данных так же задача сервиса.
Данные для передачи готовят сервисы мониторинга и аналитики в процессе обработки метрических данных. 
Явно выделенный сервис упрощает решение задачи по обеспечению отправки данных в центральное хранилище.
REST сервис сбора данных от хозяйств получает всю информацию от множества агентов и обеспечивает транспортировку данных далле в платформе АгроПром X - вся ответственность по оработке данных от агентов лежит на севисе и независим от других часте платформы АгроПром Х.


### <a name="_bjrr7veeh80c"></a>**Альтернативы**

Альтернативное решение не использовать агент а разделить его задачи между сервисами мониторинга и аналитика. 
В таком случае нет необходимости в разработке сервиса синхронизации и сервисе сбора данных. 
Данные будут отправлятся сразу в брокер сообщений платформе АгроПром X. Платформа потребует изменений для обеспечения работы с множеством платформ управления животноводческими комплексами. Использование брокера сообщений при плохом канале связи требует дополнительных его настроек.
Схема решения [C2](agrotech_v2_С2.puml)

**Недостатки, ограничения, риски**
Использование брокера Kafka на стороне хозяйства усложняет поддержку системы, повышает требования к отказоустойчивости центрального сервера.
Разработка двух дополнительных сервисов требует больше трудовых ресурсов.


